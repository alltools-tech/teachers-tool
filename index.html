<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Exam Result Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NC130TNCZL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-NC130TNCZL');
</script>
<style>
body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa;}
h2{margin-top:20px;}
.table-title {background:#222;color:#fff;font-weight:bold;padding:6px 12px;border-radius:4px 4px 0 0;margin-top:30px;display:inline-block;box-shadow:0 2px 5px rgba(0,0,0,0.12);}
.table-wrapper {border:1px solid #222;border-radius:4px;margin-bottom:28px;box-shadow:0 2px 5px rgba(0,0,0,0.08);background: #fff;padding-bottom:8px;overflow-x:auto;}
table{border-collapse:collapse;margin-top:10px;width:100%;}
th,td{border:1px solid #333;padding:4px;text-align:center;}
th {background:#222;color:#fff;}
tfoot tr, tfoot th, tfoot td {background: #222 !important;color: #fff !important;}
tfoot th, tfoot td {font-weight: bold;}
input[type="number"],input[type="text"],select{width:80px;padding:2px;}
.dob-input{width:100px;}
.error-text{color:red;font-size:12px;display:none;}
.invalid{border:2px solid red !important;}
button{padding:4px 6px;margin:2px;cursor:pointer;border-radius:3px;}
#studentsControls button,#gradeControls button,#exportControls button{margin-left:5px;background:#0077cc;color:white;border:none;}
#studentsControls button:hover,#gradeControls button:hover,#exportControls button:hover{background:#005fa3;}
.deleteBtn{background:#cc0000;color:white;border:none;padding:2px 6px;border-radius:3px;}
.deleteBtn:hover{background:#990000;}
.summary-table{margin-top:10px;width:auto;}
.grade-btn {background:#28a745;color:white;border:none;margin-left:5px;}
.grade-btn:hover {background:#1e7e34;}
.hideBtn, .showBtn {background:#ff9800;color:white;border:none;margin-left:5px;}
.hideBtn:hover, .showBtn:hover {background:#e65100;}
.hidden-column-indicator {font-size:12px;color:#b71c1c;font-weight:bold;margin-left:8px;background:#ffe0e0;border-radius:3px;padding:0 6px;}
#printOptions {margin-bottom:8px;display: flex;align-items: center;}
#printBtn {margin-left: 10px;}
#printOptions label {margin-right:8px;font-weight:bold;}
@media (max-width:600px) {.table-wrapper{padding:0;}table{font-size:13px;}#howToUseContent {max-width:96vw;}}
#howToUseModal {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.23);z-index:1000;}
#howToUseContent {background:#e3f2fd;color:#0d2346;margin:70px auto;padding:0;border-radius:8px;max-width:500px;box-shadow:0 4px 24px rgba(25,118,210,.13);position:relative;font-size:15px;max-height:80vh;overflow-y:auto;}
#howToUseContentHeader {background:#1976d2;color:#fff;font-weight:bold;padding:12px 18px;border-radius:8px 8px 0 0;font-size:18px;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center;}
#closeHowToUse {color:#fff;background:transparent;font-size:22px;font-weight:bold;border:none;cursor:pointer;margin-left:10px;transition:color 0.15s;}
.subjectLabelRow th {background:#1976d2;color:#fff;text-align:center;font-size:15px;}
.subjectNameInputBox {margin-left:12px;width:140px;}
</style>
</head>
<body>
<!-- Grade Setup -->
<div class="table-wrapper">
    <div style="display:flex;align-items:center;">
      <div class="table-title">Grade Ranges & Max Marks</div>
      <button id="howToUseBtn" type="button">How to Use</button>
    </div>
    <div id="gradeControls">
        <button class="grade-btn" data-grade-set="100">Grade-100</button>
        <button class="grade-btn" data-grade-set="80">Grade-80</button>
        <button class="grade-btn" data-grade-set="75">Grade-75</button>
        <button class="grade-btn" data-grade-set="70">Grade-70</button>
    </div>
    <table id="gradeRangesTable">
    <tr><th>Grade</th><th>From</th><th>To</th><th>From (%)</th><th>To (%)</th></tr>
    <tr><td>A+</td><td><input type="number" class="rangeFrom" data-grade="A+"></td><td><input type="number" class="rangeTo" data-grade="A+"></td><td class="percentFrom">85</td><td class="percentTo">100</td></tr>
    <tr><td>A</td><td><input type="number" class="rangeFrom" data-grade="A"></td><td><input type="number" class="rangeTo" data-grade="A"></td><td class="percentFrom">75</td><td class="percentTo">84</td></tr>
    <tr><td>B</td><td><input type="number" class="rangeFrom" data-grade="B"></td><td><input type="number" class="rangeTo" data-grade="B"></td><td class="percentFrom">60</td><td class="percentTo">74</td></tr>
    <tr><td>C</td><td><input type="number" class="rangeFrom" data-grade="C"></td><td><input type="number" class="rangeTo" data-grade="C"></td><td class="percentFrom">45</td><td class="percentTo">59</td></tr>
    <tr><td>D</td><td><input type="number" class="rangeFrom" data-grade="D"></td><td><input type="number" class="rangeTo" data-grade="D"></td><td class="percentFrom">33</td><td class="percentTo">44</td></tr>
    <tr><td>E1</td><td><input type="number" class="rangeFrom" data-grade="E1"></td><td><input type="number" class="rangeTo" data-grade="E1"></td><td class="percentFrom">20</td><td class="percentTo">32</td></tr>
    <tr><td>E2</td><td><input type="number" class="rangeFrom" data-grade="E2"></td><td><input type="number" class="rangeTo" data-grade="E2"></td><td class="percentFrom">0</td><td class="percentTo">19</td></tr>
    </table>
    Max Marks: <input type="number" id="maxMarksInput" value="100">
</div>
<!-- How To Use Modal -->
<div id="howToUseModal">
    <div id="howToUseContent">
        <div id="howToUseContentHeader">
            How to Use
            <button id="closeHowToUse" title="Close">&times;</button>
        </div>
        <div id="howToUseDetails" style="padding:18px 24px 18px 32px;">
            <ul>
              <li>Grade à¤¨à¤¿à¤•à¤¾à¤²à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¥‹à¤‚ à¤•à¤¾ Step by Step à¤ªà¤¾à¤²à¤¨ à¤•à¤°à¥‡à¤‚à¥¤</li>
              <li>à¤¸à¤¬à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ <b>Grade Range</b> à¤¸à¥‡ 100, 80, 75, 70 à¤®à¥‡à¤‚ à¤¸à¥‡ Grade à¤¸à¤¿à¤²à¥‡à¤•à¥à¤Ÿ à¤•à¤°à¥‡à¤‚à¥¤<br>
                <b>Grade à¤°à¥‡à¤‚à¤œ à¤†à¤ª à¤–à¥à¤¦ à¤­à¥€ à¤¸à¥‡à¤Ÿ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤</b>
              </li>
              <li>à¤‰à¤¸à¤•à¥‡ à¤¬à¤¾à¤¦ Student table à¤•à¥€ à¤ªà¤¹à¤²à¥€ à¤²à¤¾à¤‡à¤¨ à¤®à¥‡à¤‚ à¤ªà¤¹à¤²à¤¾ à¤°à¥‹à¤² à¤¨à¤‚à¤¬à¤° à¤¡à¤¾à¤²à¥‡à¤‚à¥¤</li>
              <li>à¤‰à¤¸à¤•à¥‡ à¤¬à¤¾à¤¦ 'Add Row' à¤¬à¤Ÿà¤¨ à¤ªà¥à¤°à¥‡à¤¸ à¤•à¤° à¤¬à¤¾à¤•à¥€ à¤²à¤¾à¤‡à¤¨ à¤à¤¡ à¤•à¤°à¥‡à¤‚à¥¤ à¤¤à¤¬ à¤…à¤—à¤²à¥‡ à¤¸à¤­à¥€ à¤°à¥‹à¤² à¤¨à¤‚à¤¬à¤° à¤­à¥€ à¤…à¤ªà¤¨à¥‡ à¤†à¤ª à¤à¤¡ à¤¹à¥‹ à¤œà¤¾à¤à¤‚à¤—à¥‡à¥¤</li>
              <li>à¤«à¤¿à¤° à¤¨à¤¾à¤®, à¤œà¤¨à¥à¤® à¤¦à¤¿à¤¨à¤¾à¤‚à¤•, à¤²à¤¿à¤‚à¤—, à¤œà¤¾à¤¤à¤¿ à¤­à¤°à¥‡à¤‚à¥¤ à¤œà¥‹ à¤•à¥‰à¤²à¤® à¤¨à¤¹à¥€à¤‚ à¤šà¤¾à¤¹à¤¿à¤ à¤‰à¤¸à¥‡ <b>'Hide Column'</b> à¤¸à¥‡ à¤¹à¤¾à¤‡à¤¡ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤œà¤¬ à¤šà¤¾à¤¹à¥‡à¤‚ à¤¤à¥‹ <b>'Show Column'</b> à¤¸à¥‡ à¤µà¤¾à¤ªà¤¸ à¤¦à¥‡à¤– à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤</li>
              <li>à¤…à¤‚à¤¤ à¤®à¥‡à¤‚ <b>'Obtained Marks'</b> à¤®à¥‡à¤‚ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤­à¤°à¤¤à¥‡ à¤œà¤¾à¤à¤‚à¥¤</li>
              <li>à¤…à¤‚à¤• 2 à¤¡à¤¿à¤œà¤¿à¤Ÿ à¤®à¥‡à¤‚ à¤¹à¥€ à¤­à¤°à¥‡à¤‚à¥¤ à¤œà¥ˆà¤¸à¥‡ 0 à¤¸à¥‡ 9 à¤¤à¤• à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤¹à¥‹à¤¨à¥‡ à¤ªà¤° 00, 01, 02 à¤†à¤¦à¤¿ à¤­à¤°à¥‡à¤‚à¥¤ à¤¦à¥‹ à¤¡à¤¿à¤œà¤¿à¤Ÿ à¤­à¤°à¤¨à¥‡ à¤ªà¤° à¤•à¤°à¤¸à¤° à¤…à¤—à¤²à¥‡ à¤•à¥‰à¤²à¤® à¤®à¥‡à¤‚ à¤šà¤²à¤¾ à¤œà¤¾à¤à¤—à¤¾à¥¤ à¤œà¤¿à¤¸à¤¸à¥‡ à¤†à¤ªà¤•à¤¾ à¤•à¤¾à¤® à¤«à¤¾à¤¸à¥à¤Ÿ à¤¹à¥‹à¤—à¤¾à¥¤</li>
              <li>à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤­à¤°à¤¨à¥‡ à¤ªà¤° à¤†à¤ªà¤•à¥‡ Grade, à¤ªà¥à¤°à¤¤à¤¿à¤¶à¤¤ à¤”à¤° Grade à¤µà¤¾à¤‡à¤œ, à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤‡à¤œ, à¤²à¤¿à¤‚à¤— à¤µà¤¾à¤‡à¤œ à¤—à¥‹à¤¶à¤µà¤¾à¤°à¤¾ à¤®à¤¿à¤² à¤œà¤¾à¤à¤—à¤¾à¥¤</li>
              <li>à¤²à¤¿à¤‚à¤— à¤”à¤° à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤‡à¤œ à¤—à¥‹à¤¶à¤µà¤¾à¤°à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤ªà¤•à¥‹ à¤¸à¥à¤Ÿà¥‚à¤¡à¥‡à¤‚à¤Ÿ à¤•à¥‡ à¤²à¤¿à¤‚à¤— à¤”à¤° à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤²à¥‡ à¤•à¥‰à¤²à¤® à¤­à¤°à¤¨à¤¾ à¤¹à¥‹à¤‚à¤—à¥‡à¥¤</li>
              <li>à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤®à¥‡à¤‚ à¤¸à¤¿à¤²à¥‡à¤•à¥à¤Ÿ à¤‘à¤ªà¥à¤¶à¤¨ à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤†à¤ª à¤œà¥‹ à¤¡à¥‡à¤Ÿà¤¾ à¤šà¤¾à¤¹à¥‡à¤‚ à¤‰à¤¸à¥‡ à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤¯à¤¾ <b>PDF</b> à¤¸à¥‡à¤µ à¤•à¤° à¤¸à¤•à¥‡à¤‚à¤—à¥‡à¥¤</li>
              <li>Reset Student Table à¤¸à¥‡ à¤ªà¥‚à¤°à¥€ à¤Ÿà¥‡à¤¬à¤² à¤°à¤¿à¤¸à¥‡à¤Ÿ à¤¹à¥‹ à¤œà¤¾à¤à¤—à¥€à¥¤</li>
              <li>Delete à¤‘à¤ªà¥à¤¶à¤¨ à¤¸à¥‡ à¤ªà¥‚à¤°à¥€ à¤²à¤¾à¤‡à¤¨ à¤¡à¤¿à¤²à¥€à¤Ÿ à¤¹à¥‹ à¤œà¤¾à¤à¤—à¥€à¥¤</li>
              <li>à¤•à¥ƒà¤ªà¤¯à¤¾ à¤•à¥‹à¤ˆ error à¤¯à¤¾ à¤¸à¥à¤à¤¾à¤µ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¤®à¥‡à¤‚ E-mail à¤•à¤°à¥‡à¤‚à¥¤<br>
                <b>E-mail us at: <a href="mailto:skycommunics@gmail.com" class="email-link">skycommunics@gmail.com</a></b>
              </li>
            </ul>
        </div>
    </div>
</div>
<!-- Student Table -->
<div class="table-wrapper">
    <div class="table-title">Students Table</div>
    <div id="studentsControls">
        <label for="hideColumnSelect">Hide Column:</label>
        <select id="hideColumnSelect" class="hideBtn"></select>
        <label for="showColumnSelect">Show Column:</label>
        <select id="showColumnSelect" class="showBtn"></select>
        <button id="resetStudentsBtn">Reset Student Table</button>
        <span id="hiddenColumnsIndicator"></span>
    </div>
    <table id="studentsTable">
    <thead>
    <tr>
        <th rowspan="2">S.No</th>
        <th rowspan="2">Roll No</th>
        <th rowspan="2">Name</th>
        <th rowspan="2">Gender</th>
        <th rowspan="2">Caste</th>
        <th rowspan="2">DOB</th>
        <th colspan="5" class="subjectLabelRow">
            Subject
            <input type="text" id="subjectNameInput" class="subjectNameInputBox" placeholder="Subject Name">
        </th>
        <th rowspan="2">Action</th>
    </tr>
    <tr class="subjectLabelRow">
        <th>Obtained Marks</th>
        <th>Grade</th>
        <th>Percentage</th>
        <th>Project Marks</th>
        <th>Total</th>
    </tr>
    </thead>
    <tbody></tbody>
    </table>
    <button id="addRowBtn">+ Add Row</button>
</div>
<!-- Summaries -->
<div class="table-wrapper">
    <div class="table-title">Grade Summary</div>
    <table id="gradeSummary" class="summary-table">
    <thead><tr><th>Grade</th><th>Count</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th>Total</th><th id="gradeTotal">-</th></tr></tfoot>
    </table>
</div>
<div class="table-wrapper">
    <div class="table-title">Gender-wise Grade Summary</div>
    <table id="genderSummary" class="summary-table">
    <thead>
        <tr>
            <th>Gender</th>
            <th>A+</th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
            <th>D</th>
            <th>E1</th>
            <th>E2</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Male</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
        <tr>
            <td>Female</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td>Total</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
    </tfoot>
    </table>
</div>
<div class="table-wrapper">
    <div class="table-title">Caste-wise Grade Summary</div>
    <table id="casteSummary" class="summary-table">
    <thead>
        <tr>
            <th>Caste</th>
            <th>A+</th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
            <th>D</th>
            <th>E1</th>
            <th>E2</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>SC</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
        <tr>
            <td>ST</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
        <tr>
            <td>OBC</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
        <tr>
            <td>General</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td>Total</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
    </tfoot>
    </table>
</div>
<!-- Export and Print -->
<div class="table-wrapper">
    <div id="exportControls">
        <button id="exportExcelBtn">Export to Excel</button>
        <div id="printOptions">
            <label for="printSelect">selec:</label>
            <select id="printSelect">
                <option value="students" selected>Students Table</option>
                <option value="grade">Grade Summary</option>
                <option value="gender">Gender Wise</option>
                <option value="caste">Caste Wise</option>
                <option value="all">All</option>
            </select>
            <button id="printBtn">Print</button>
        </div>
    </div>
</div>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// --- Modal Logic --- (unchanged)
document.getElementById("howToUseBtn").onclick = function() {
    document.getElementById("howToUseModal").style.display = "block";
    document.body.style.overflow = "hidden";
};
document.getElementById("closeHowToUse").onclick = function() {
    document.getElementById("howToUseModal").style.display = "none";
    document.body.style.overflow = "";
};
document.getElementById("howToUseModal").onclick = function(e) {
    if(e.target === this) {
        this.style.display = "none";
        document.body.style.overflow = "";
    }
};
// --- State and Utility ---
let hiddenColumns = [];
const columnNames = [
    "S.No", "Roll No", "Name", "Gender", "Caste", "DOB",
    "Obtained Marks", "Grade", "Percentage", "Project Marks", "Total", "Action"
];
// ---- GRADE RANGES ----
const percentGradeRanges = [
    {grade:"A+", from:85, to:100},
    {grade:"A", from:75, to:84},
    {grade:"B", from:60, to:74},
    {grade:"C", from:45, to:59},
    {grade:"D", from:33, to:44},
    {grade:"E1", from:20, to:32},
    {grade:"E2", from:0, to:19}
];
function setGradeRangesFromPercent(maxMarks) {
    document.querySelectorAll("#gradeRangesTable tr").forEach((tr, idx) => {
        if(idx==0) return;
        let pf = tr.querySelector(".percentFrom");
        let pt = tr.querySelector(".percentTo");
        let rf = tr.querySelector(".rangeFrom");
        let rt = tr.querySelector(".rangeTo");
        let percentFrom = parseInt(pf.textContent);
        let percentTo = parseInt(pt.textContent);
        rf.value = Math.round(percentFrom * maxMarks / 100);
        rt.value = Math.round(percentTo * maxMarks / 100);
    });
}
function setPercentRangesFromInputs(maxMarks) {
    document.querySelectorAll("#gradeRangesTable tr").forEach((tr, idx) => {
        if(idx==0) return;
        let rf = tr.querySelector(".rangeFrom").value;
        let rt = tr.querySelector(".rangeTo").value;
        let pf = tr.querySelector(".percentFrom");
        let pt = tr.querySelector(".percentTo");
        pf.textContent = Math.round((rf / maxMarks) * 100);
        pt.textContent = Math.round((rt / maxMarks) * 100);
    });
}
function saveToLocalStorage(data) {localStorage.setItem("studentsTableData", JSON.stringify(data));}
function loadFromLocalStorage() {let data = localStorage.getItem("studentsTableData");return data ? JSON.parse(data) : null;}
function getCurrentData() {
    let students = [];
    document.querySelectorAll("#studentsTable tbody tr").forEach(row => {
        students.push({
            roll: row.querySelector(".roll")?.value || "",
            name: row.querySelector('input[type="text"]')?.value || "",
            gender: row.querySelector(".gender")?.value || "",
            caste: row.querySelector(".caste")?.value || "",
            dob: row.querySelector(".dob-input")?.value || "",
            marks: row.querySelector(".marks")?.value || "",
            project: row.querySelector(".projectMarks")?.value || "",
            total: row.querySelector(".totalMarks")?.value || ""
        });
    });
    let gradeRanges = [];
    document.querySelectorAll("#gradeRangesTable tr").forEach((tr, idx) => {
        if(idx==0) return;
        gradeRanges.push({
            grade: tr.cells[0].textContent,
            from: tr.cells[1].querySelector("input").value,
            to: tr.cells[2].querySelector("input").value
        });
    });
    let maxMarks = document.getElementById("maxMarksInput").value;
    let subjectName = document.getElementById("subjectNameInput").value || "";
    return {students, gradeRanges, maxMarks, subjectName};
}
function restoreData(data) {
    if(data.gradeRanges){
        let trs = document.querySelectorAll("#gradeRangesTable tr");
        data.gradeRanges.forEach((gr, i) => {
            if(trs[i+1]) {
                trs[i+1].cells[1].querySelector("input").value = gr.from;
                trs[i+1].cells[2].querySelector("input").value = gr.to;
            }
        });
        setPercentRangesFromInputs(parseInt(data.maxMarks||100));
    }
    if(data.maxMarks){
        document.getElementById("maxMarksInput").value = data.maxMarks;
    }
    if(data.subjectName){
        document.getElementById("subjectNameInput").value = data.subjectName;
    }
    const tbody=document.querySelector("#studentsTable tbody");
    tbody.innerHTML="";
    if(data.students && data.students.length>0){
        data.students.forEach((st,i)=>{
            let row = addRow(st.roll);
            row.querySelector('input[type="text"]').value = st.name;
            row.querySelector(".gender").value = st.gender;
            row.querySelector(".caste").value = st.caste;
            row.querySelector(".dob-input").value = st.dob;
            row.querySelector(".marks").value = st.marks;
            row.querySelector(".projectMarks").value = st.project;
            row.querySelector(".totalMarks").value = st.total;
        });
    } else {
        addRow();
    }
}
function updateHideShowSelects() {
    const hideSelect = document.getElementById('hideColumnSelect');
    const showSelect = document.getElementById('showColumnSelect');
    hideSelect.innerHTML = '';
    showSelect.innerHTML = '';
    let firstOpt = document.createElement('option');
    firstOpt.textContent = 'Select';
    firstOpt.value = '';
    firstOpt.disabled = true;
    firstOpt.selected = true;
    hideSelect.appendChild(firstOpt);
    columnNames.forEach((col, idx) => {
        if(!hiddenColumns.includes(idx) && idx !== 0 && idx !== columnNames.length-1){
            let opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = col;
            hideSelect.appendChild(opt);
        }
    });
    let firstOptShow = document.createElement('option');
    firstOptShow.textContent = 'Select';
    firstOptShow.value = '';
    firstOptShow.disabled = true;
    firstOptShow.selected = true;
    showSelect.appendChild(firstOptShow);
    hiddenColumns.forEach(idx => {
        if(idx !== 0 && idx !== columnNames.length-1){
            let opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = columnNames[idx];
            showSelect.appendChild(opt);
        }
    });
    if(hideSelect.options.length===1){
        let opt = document.createElement('option');
        opt.textContent = 'No column to hide';
        opt.disabled = true;
        hideSelect.appendChild(opt);
    }
    if(showSelect.options.length===1){
        let opt = document.createElement('option');
        opt.textContent = 'No column to show';
        opt.disabled = true;
        showSelect.appendChild(opt);
    }
    hideSelect.selectedIndex = 0;
    showSelect.selectedIndex = 0;
}
function updateHiddenColumnsIndicator() {
    const indicator = document.getElementById('hiddenColumnsIndicator');
    if(hiddenColumns.length === 0) {
        indicator.innerHTML = "";
        return;
    }
    let html = "Hidden: ";
    hiddenColumns.forEach(idx => {
        html += `<span class="hidden-column-indicator" data-index="${idx}">${columnNames[idx]}</span>`;
    });
    indicator.innerHTML = html;
}
document.getElementById("hideColumnSelect").addEventListener("change", function(){
    let idx = parseInt(this.value);
    if(hiddenColumns.includes(idx) || idx < 1 || idx === columnNames.length-1) return;
    document.querySelectorAll("#studentsTable thead th")[idx].style.display="none";
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        if(row.cells[idx]) row.cells[idx].style.display="none";
    });
    hiddenColumns.push(idx);
    updateHideShowSelects();
    updateHiddenColumnsIndicator();
});
document.getElementById("showColumnSelect").addEventListener("change", function(){
    let idx = parseInt(this.value);
    if(!hiddenColumns.includes(idx)) return;
    document.querySelectorAll("#studentsTable thead th")[idx].style.display="";
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        if(row.cells[idx]) row.cells[idx].style.display="";
    });
    hiddenColumns = hiddenColumns.filter(i=>i!==idx);
    updateHideShowSelects();
    updateHiddenColumnsIndicator();
});
document.getElementById('hiddenColumnsIndicator').addEventListener('click', function(e){
    if(e.target.classList.contains('hidden-column-indicator')) {
        let idx = parseInt(e.target.dataset.index);
        document.querySelectorAll("#studentsTable thead th")[idx].style.display="";
        document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
            if(row.cells[idx]) row.cells[idx].style.display="";
        });
        hiddenColumns = hiddenColumns.filter(i=>i!==idx);
        updateHideShowSelects();
        updateHiddenColumnsIndicator();
    }
});
function getGrade(marks){
    const ranges={};
    document.querySelectorAll(".rangeFrom").forEach((f,i)=>{
        const g=f.dataset.grade;
        ranges[g]=[parseInt(f.value),parseInt(document.querySelectorAll(".rangeTo")[i].value)];
    });
    for(let g in ranges){
        let [from,to]=ranges[g];
        if(marks>=from && marks<=to) return g;
    }
    return "";
}
function updateAllRows(){
    const maxMarks=parseFloat(document.getElementById("maxMarksInput").value)||100;
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        const marksInput=row.querySelector(".marks");
        const projectInput=row.querySelector(".projectMarks");
        const totalInput=row.querySelector(".totalMarks");
        let marks=parseFloat(marksInput.value);
        let project=parseFloat(projectInput.value);
        let total="";
        if(!isNaN(marks) && !isNaN(project)){
            total = marks+project;
            totalInput.value = total;
        } else if(!isNaN(marks)){
            total = marks;
            totalInput.value = total;
        } else if(!isNaN(project)){
            total = project;
            totalInput.value = total;
        } else {
            totalInput.value = "";
        }
        if(!isNaN(marks) && marks>maxMarks){
            marksInput.classList.add("invalid");
        } else {
            marksInput.classList.remove("invalid");
        }
        const gradeCell=row.querySelector(".grade");
        const percentCell=row.querySelector(".percent");
        if(!isNaN(marks)){
            let grade=getGrade(marks);
            gradeCell.textContent=grade;
            percentCell.textContent=((marks/maxMarks)*100).toFixed(2);
        } else {
            gradeCell.textContent="";
            percentCell.textContent="";
        }
    });
    updateAllSummaries();
    saveToLocalStorage(getCurrentData());
}
function attachRowEvents(row){
    row.querySelector(".marks").addEventListener("input",function(e){
        const maxMarks = parseFloat(document.getElementById("maxMarksInput").value)||100;
        let val = parseFloat(this.value);
        if(!isNaN(val) && val>maxMarks){
            this.classList.add("invalid");
        } else {
            this.classList.remove("invalid");
        }
        updateAllRows();
        if(this.value.length >= 2){
            let currRow = this.closest('tr');
            let allRows = Array.from(document.querySelectorAll("#studentsTable tbody tr"));
            let idx = allRows.indexOf(currRow);
            if(idx < allRows.length-1){
                let nextRow = allRows[idx+1];
                let nextInput = nextRow.querySelector(".marks");
                if(nextInput) nextInput.focus();
            }
        }
    });
    row.querySelector(".projectMarks").addEventListener("input",function(e){
        updateAllRows();
    });
    row.querySelector(".totalMarks").addEventListener("input",function(e){
    });
    row.querySelector(".roll").addEventListener("input",updateAllRows);
    row.querySelector('input[type="text"]').addEventListener("input",updateAllRows);
    row.querySelector(".gender").addEventListener("change",updateAllRows);
    row.querySelector(".caste").addEventListener("change",updateAllRows);
    row.querySelector(".deleteBtn").addEventListener("click",()=>{
        row.remove();
        updateSerialNumbers();
        updateAllRows();
    });
    let dobInput = row.querySelector(".dob-input");
    dobInput.addEventListener("input",function(e){
        let v = dobInput.value.replace(/[^\d]/g,"");
        if(v.length>2) v = v.slice(0,2)+"/"+v.slice(2);
        if(v.length>5) v = v.slice(0,5)+"/"+v.slice(5);
        dobInput.value = v.slice(0,10);
        let parts = dobInput.value.split("/");
        let invalid=false;
        if(parts.length===3) {
            let d = parseInt(parts[0]), m = parseInt(parts[1]), y = parseInt(parts[2]);
            let dateObj = new Date(y,m-1,d);
            if(isNaN(dateObj.getTime()) || d<1 || m<1 || m>12 || y<1900 || y>2100 ||
                dateObj.getDate()!=d || dateObj.getMonth()!=m-1 || dateObj.getFullYear()!=y) {
                invalid=true;
            }
        } else if(dobInput.value.length===10) {
            invalid=true;
        }
        let err = dobInput.nextElementSibling;
        if(invalid) {
            dobInput.classList.add("invalid");
            err.style.display="block";
        } else {
            dobInput.classList.remove("invalid");
            err.style.display="none";
        }
        updateAllRows();
    });
    dobInput.addEventListener("blur",updateAllRows);
}
function addRow(rollNo){
    const tbody=document.querySelector("#studentsTable tbody");
    const row=document.createElement("tr");
    const serial=tbody.children.length+1;
    row.innerHTML=`
        <td>${serial}</td>
        <td><input type="number" class="roll"></td>
        <td><input type="text" placeholder="Name"></td>
        <td><select class="gender">
            <option value="">--</option>
            <option value="M">M</option>
            <option value="F">F</option>
          </select></td>
        <td><select class="caste">
            <option value="">--</option>
            <option value="SC">SC</option>
            <option value="ST">ST</option>
            <option value="OBC">OBC</option>
            <option value="General">General</option>
          </select></td>
        <td><input type="text" class="dob-input" placeholder="DD/MM/YYYY" maxlength="10"><div class="error-text">Invalid Date</div></td>
        <td><input type="number" class="marks"></td>
        <td class="grade"></td>
        <td class="percent"></td>
        <td><input type="number" class="projectMarks" placeholder="Project"></td>
        <td><input type="number" class="totalMarks" placeholder="Total"></td>
        <td><button class="deleteBtn">Delete</button></td>`;
    tbody.appendChild(row);
    if(rollNo) row.querySelector(".roll").value=rollNo;
    attachRowEvents(row);
    hiddenColumns.forEach(idx=>{
        if(row.cells[idx]) row.cells[idx].style.display="none";
    });
    return row;
}
function updateSerialNumbers(){
    document.querySelectorAll("#studentsTable tbody tr").forEach((r,i)=>r.cells[0].textContent=i+1);
}
function updateAllSummaries(){
    let gradeCounts={"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0};
    let genderCounts={"M":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"F":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0}};
    let casteCounts={"SC":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"ST":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"OBC":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"General":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0}};
    document.querySelectorAll("#studentsTable tbody tr").forEach(r=>{
        let grade=r.querySelector(".grade").textContent;
        let gender=r.querySelector(".gender").value;
        let caste=r.querySelector(".caste").value;
        if(gradeCounts[grade]!=undefined) gradeCounts[grade]++;
        if(gender && genderCounts[gender][grade]!=undefined) genderCounts[gender][grade]++;
        if(caste && casteCounts[caste][grade]!=undefined) casteCounts[caste][grade]++;
    });
    let gradeBody=document.querySelector("#gradeSummary tbody");
    gradeBody.innerHTML="";
    let totalGrades=0;
    for(let g in gradeCounts){
        gradeBody.innerHTML+=`<tr><td>${g}</td><td>${gradeCounts[g]||"-"}</td></tr>`;
        totalGrades+=gradeCounts[g];
    }
    document.getElementById("gradeTotal").textContent=totalGrades||"-";
    let genderRows=document.querySelectorAll("#genderSummary tbody tr");
    ["M","F"].forEach((g,i)=>{
        let tds=genderRows[i].querySelectorAll("td");
        let rowTotal=0;
        let j=1;
        for(let gr in gradeCounts){
            tds[j].textContent=genderCounts[g][gr]||"-";
            rowTotal+=genderCounts[g][gr];
            j++;
        }
        tds[tds.length-1].textContent=rowTotal||"-";
    });
    let totalRow=document.querySelector("#genderSummary tfoot tr");
    totalRow.querySelectorAll("td").forEach((td,idx)=>{
        if(idx===0){td.textContent="Total"; return;}
        let sum=0;
        ["M","F"].forEach(g=>{sum+=parseInt(document.querySelector(`#genderSummary tbody tr:nth-child(${g=="M"?1:2}) td:nth-child(${idx+1})`).textContent)||0;});
        td.textContent=sum||"-";
    });
    let casteRows=document.querySelectorAll("#casteSummary tbody tr");
    ["SC","ST","OBC","General"].forEach((c,i)=>{
        let tds=casteRows[i].querySelectorAll("td");
        let rowTotal=0;
        let j=1;
        for(let gr in gradeCounts){
            tds[j].textContent=casteCounts[c][gr]||"-";
            rowTotal+=casteCounts[c][gr];
            j++;
        }
        tds[tds.length-1].textContent=rowTotal||"-";
    });
    let casteTotalRow=document.querySelector("#casteSummary tfoot tr");
    casteTotalRow.querySelectorAll("td").forEach((td,idx)=>{
        if(idx===0){td.textContent="Total"; return;}
        let sum=0;
        ["SC","ST","OBC","General"].forEach((c,i)=>{sum+=parseInt(casteRows[i].querySelectorAll("td")[idx].textContent)||0;});
        td.textContent=sum||"-";
    });
}
document.getElementById("addRowBtn").addEventListener("click",()=>{
    const tbody=document.querySelector("#studentsTable tbody");
    let lastRoll=tbody.lastElementChild?parseInt(tbody.lastElementChild.querySelector(".roll").value)||0:0;
    addRow(lastRoll+1);
    updateAllRows();
});
document.getElementById("resetStudentsBtn").addEventListener("click",()=>{
    document.querySelector("#studentsTable tbody").innerHTML="";
    addRow();
    updateAllRows();
    localStorage.removeItem("studentsTableData");
});
document.querySelectorAll(".rangeFrom, .rangeTo").forEach(inp=>inp.addEventListener("input",function(){
    let maxMarks = parseInt(document.getElementById("maxMarksInput").value)||100;
    setPercentRangesFromInputs(maxMarks);
    updateAllRows();
}));
document.getElementById("maxMarksInput").addEventListener("input",function(){
    let maxMarks = parseInt(this.value)||100;
    setGradeRangesFromPercent(maxMarks);
    updateAllRows();
});
document.getElementById("subjectNameInput").addEventListener("input",function(){
    saveToLocalStorage(getCurrentData());
});
window.addEventListener("DOMContentLoaded",function(){
    let maxMarks = parseInt(document.getElementById("maxMarksInput").value)||100;
    setGradeRangesFromPercent(maxMarks);
    let data = loadFromLocalStorage();
    if(data){restoreData(data);}else{addRow();}
    updateAllRows();
    updateHideShowSelects();
    document.getElementById('printSelect').selectedIndex = 0;
});
document.addEventListener("input",function(e){
    if(e.target.closest("#studentsTable") || e.target.closest("#gradeRangesTable") || e.target.id=="maxMarksInput"){
        saveToLocalStorage(getCurrentData());
    }
});
function sanitizeExcel(val) {
    if(val == null || val === undefined) return "N/A";
    let s = String(val).replace(/[\r\n\t]/g, " ").replace(/^\s+|\s+$/g, "");
    if(s === "" || s === "--") return "N/A";
    return s;
}
function getVisibleIndices() {
    const ths = Array.from(document.querySelector("#studentsTable thead tr").cells);
    let idxs = [];
    for(let i=0;i<ths.length-1;i++) {
        if(ths[i].style.display !== "none") idxs.push(i);
    }
    return idxs;
}
document.getElementById("exportExcelBtn").addEventListener("click",()=>{
    updateAllRows();
    const table = document.getElementById("studentsTable");
    const thead = table.querySelector("thead tr");
    let visibleIdx = getVisibleIndices();
    let colNames = visibleIdx.map(idx=>thead.cells[idx].textContent.trim());
    const tbody = table.querySelector("tbody");
    let data = [];
    for(let row of tbody.rows) {
        let rowData = [];
        visibleIdx.forEach(idx=>{
            let cell = row.cells[idx];
            let val = "";
            let input = cell.querySelector("input");
            let select = cell.querySelector("select");
            if(select) {
                let opt = select.options[select.selectedIndex];
                val = opt && opt.value ? opt.textContent : "N/A";
            } else if(input) {
                val = input.value;
            } else {
                val = cell.textContent;
            }
            rowData.push(sanitizeExcel(val));
        });
        data.push(rowData);
    }
    let ws_data = [colNames, ...data];
    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    function sheetFromTable(id) {
        let tab = document.getElementById(id);
        let rows = tab.rows;
        let sdata = [];
        for(let r=0; r<rows.length; r++) {
            let rowArr = [];
            for(let c=0; c<rows[r].cells.length; c++) {
                let cell = rows[r].cells[c];
                rowArr.push(sanitizeExcel(cell.textContent));
            }
            sdata.push(rowArr);
        }
        return XLSX.utils.aoa_to_sheet(sdata);
    }
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Students");
    XLSX.utils.book_append_sheet(wb, sheetFromTable("gradeSummary"), "Grade Summary");
    XLSX.utils.book_append_sheet(wb, sheetFromTable("genderSummary"), "Gender Summary");
    XLSX.utils.book_append_sheet(wb, sheetFromTable("casteSummary"), "Caste Summary");
    XLSX.writeFile(wb, "Student_Grades.xlsx");
});
document.getElementById('printBtn').addEventListener('click', function() {
    updateAllRows();
    const printSelect = document.getElementById('printSelect').value;
    let printContents = '';
    function tableToPrintHtml(tableId){
        const table = document.getElementById(tableId);
        if(!table) return '';
        let clone = table.cloneNode(true);
        let hiddenIdxs = [...hiddenColumns];
        let actionIdx = Array.from(clone.querySelectorAll('thead th')).findIndex(th => th.textContent.trim().toLowerCase() === 'action');
        if(actionIdx >= 0) hiddenIdxs = [...hiddenIdxs, actionIdx];
        hiddenIdxs = [...new Set(hiddenIdxs)].sort((a,b)=>b-a);
        let ths = clone.querySelectorAll('thead tr th');
        hiddenIdxs.forEach(idx=>{if(ths[idx]) ths[idx].remove();});
        clone.querySelectorAll('tbody tr').forEach(tr=>{
            hiddenIdxs.forEach(idx=>{if(tr.cells[idx]) tr.cells[idx].remove();});
            Array.from(tr.cells).forEach((td, i)=>{
                let input = td.querySelector('input');
                let select = td.querySelector('select');
                if(input) {
                    td.textContent = input.value && input.value.trim() ? input.value : "N/A";
                }
                else if(select) {
                    let val = select.value;
                    let thList = Array.from(table.querySelectorAll('thead tr th')).map(th => th.textContent.trim().toLowerCase());
                    let genderIdx = thList.indexOf('gender');
                    let casteIdx = thList.indexOf('caste');
                    if(i === genderIdx) {
                        td.textContent = (val === "M") ? "Male" : (val === "F") ? "Female" : "N/A";
                    }
                    else if(i === casteIdx) {
                        td.textContent = val ? val : "N/A";
                    }
                    else {
                        td.textContent = val ? val : "N/A";
                    }
                }
            });
        });
        clone.querySelectorAll('tfoot tr').forEach(tr=>{
            hiddenIdxs.forEach(idx=>{if(tr.cells[idx]) tr.cells[idx].remove();});
        });
        clone.querySelectorAll('button').forEach(btn=>btn.remove());
        let parent = table.parentNode;
        let title = parent.querySelector('.table-title') ? parent.querySelector('.table-title').outerHTML : '';
        return '<div class="table-title">'+title.replace(/<[^>]*>/g,'')+'</div>' + clone.outerHTML;
    }
    if(printSelect==='students'){
        printContents += tableToPrintHtml('studentsTable');
    }
    else if(printSelect==='grade'){
        printContents += tableToPrintHtml('gradeSummary');
    }
    else if(printSelect==='gender'){
        printContents += tableToPrintHtml('genderSummary');
    }
    else if(printSelect==='caste'){
        printContents += tableToPrintHtml('casteSummary');
    }
    else if(printSelect==='all'){
        printContents += tableToPrintHtml('studentsTable');
        printContents += tableToPrintHtml('gradeSummary');
        printContents += tableToPrintHtml('genderSummary');
        printContents += tableToPrintHtml('casteSummary');
    }
    if(printContents){
        let printWindow = window.open('', '', 'height=700,width=900');
        printWindow.document.write('<html><head><title>Print</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa;}
            h2{margin-top:20px;}
            .table-title { background:#222; color:#fff; font-weight:bold; padding:6px 12px; border-radius:4px 4px 0 0; margin-top:30px; display:inline-block; box-shadow:0 2px 5px rgba(0,0,0,0.12);}
            .table-wrapper { border:1px solid #222; border-radius:4px; margin-bottom:28px; box-shadow:0 2px 5px rgba(0,0,0,0.08); background: #fff; padding-bottom:8px; overflow-x:auto;}
            table{border-collapse:collapse;margin-top:10px;width:100%;}
            th,td{border:1px solid #333;padding:4px;text-align:center;}
            th { background:#222; color:#fff; }
            tfoot tr, tfoot th, tfoot td { background: #222 !important; color: #fff !important;}
            tfoot th, tfoot td { font-weight: bold;}
            .summary-table{margin-top:10px;width:auto;}
            @media (max-width:600px) {.table-wrapper{padding:0;}table{font-size:13px;}}
        `);
        printWindow.document.write('</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<div class="table-wrapper">' + printContents + '</div>');
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.onload = function(){
            printWindow.focus();
            printWindow.print();
        };
    }
});
</script>
</body> 
</html>