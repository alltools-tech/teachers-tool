<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grand Final Student Management</title>
<style>
body{font-family:Arial,sans-serif;margin:20px;}
h2{margin-top:20px;}
.table-title {
    background:#222;
    color:#fff;
    font-weight:bold;
    padding:6px 12px;
    border-radius:4px 4px 0 0;
    margin-top:30px;
    display:inline-block;
    box-shadow:0 2px 5px rgba(0,0,0,0.12);
}
.table-wrapper {
    border:1px solid #222;
    border-radius:4px;
    margin-bottom:28px;
    box-shadow:0 2px 5px rgba(0,0,0,0.08);
    background: #fff;
    padding-bottom:8px;
}
table{border-collapse:collapse;margin-top:10px;width:auto;}
th,td{border:1px solid #333;padding:4px;text-align:center;}
th {
    background:#222;
    color:#fff;
}
tfoot tr, tfoot th, tfoot td {
    background: #222 !important;
    color: #fff !important;
}
tfoot th, tfoot td {
    font-weight: bold;
}
input[type="number"],input[type="text"],select{width:80px;padding:2px;}
.dob-input{width:100px;}
.error-text{color:red;font-size:12px;display:none;}
.invalid{border:2px solid red !important;}
button{padding:4px 6px;margin:2px;cursor:pointer;border-radius:3px;}
#studentsControls button,#gradeControls button,#exportControls button{margin-left:5px;background:#0077cc;color:white;border:none;}
#studentsControls button:hover,#gradeControls button:hover,#exportControls button:hover{background:#005fa3;}
.deleteBtn{background:#cc0000;color:white;border:none;padding:2px 6px;border-radius:3px;}
.deleteBtn:hover{background:#990000;}
.summary-table{margin-top:10px;width:auto;}
.grade-btn {background:#28a745;color:white;border:none;margin-left:5px;}
.grade-btn:hover {background:#1e7e34;}
.hideBtn, .showBtn {
    background:#ff9800;
    color:white;
    border:none;
    margin-left:5px;
}
.hideBtn:hover, .showBtn:hover {
    background:#e65100;
}
.hidden-column-indicator {
    font-size:12px;
    color:#b71c1c;
    font-weight:bold;
    margin-left:8px;
    background:#ffe0e0;
    border-radius:3px;
    padding:0 6px;
}
#hideColumnSelect, #showColumnSelect, #printSelect {
    margin-left:5px;
    padding:2px 8px;
    background:#e0e0e0;
    color:#333;
    border-radius:3px;
    border:1px solid #aaa;
}
#printOptions {
    margin-bottom:8px;
    display: flex;
    align-items: center;
}
#printBtn {
    margin-left: 10px;
}
#printOptions label {
    margin-right:8px;
    font-weight:bold;
}

/* How to Use Modal */
#howToUseBtn {
    background: #1976d2;
    color: #fff;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    margin-left: 16px;
    padding: 6px 14px;
    font-size: 15px;
    box-shadow: 0 2px 8px rgba(25,118,210,0.10);
}
#howToUseBtn:hover {
    background: #1255a6;
}
#howToUseModal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    overflow: auto;
    background: rgba(40,60,80,0.26);
}
#howToUseContent {
    background: #e3f2fd;
    color: #0d2346;
    margin: 70px auto;
    padding: 0;
    border-radius: 8px;
    max-width: 500px;
    box-shadow: 0 4px 24px rgba(25,118,210,.13);
    position: relative;
    font-size: 15px;
    animation: fadeIn .24s;
}
@keyframes fadeIn {
    from {transform: scale(0.94);opacity:0;}
    to   {transform: scale(1);opacity:1;}
}
#howToUseContentHeader {
    background: #1976d2;
    color: #fff;
    font-weight: bold;
    padding: 12px 18px;
    border-radius: 8px 8px 0 0;
    font-size: 18px;
    letter-spacing: 1px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#closeHowToUse {
    color: #fff;
    background: transparent;
    font-size: 22px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    margin-left: 10px;
    transition: color 0.15s;
}
#closeHowToUse:hover {
    color: #ffecb3;
}
#howToUseDetails {
    padding: 18px 24px 18px 32px;
}
#howToUseDetails ul {
    margin: 0 0 0 0;
    padding: 0 0 0 20px;
}
#howToUseDetails li {
    margin-bottom: 7px;
    list-style-type: disc;
}
#howToUseDetails .email-link {
    color:#1976d2;
    text-decoration:underline;
    word-break:break-all;
}
@media (max-width:600px) {
    #howToUseContent {max-width:95vw;}
    #howToUseDetails {padding: 14px 8px 14px 18px;}
    #howToUseContentHeader {font-size: 16px; padding:8px 12px;}
}
</style>
</head>
<body>

<div class="table-wrapper">
    <div style="display:flex;align-items:center;">
      <div class="table-title">Grade Ranges & Max Marks</div>
      <button id="howToUseBtn" type="button">How to Use</button>
    </div>
    <div id="gradeControls">
        <button class="grade-btn" data-grade-set="100">Grade-100</button>
        <button class="grade-btn" data-grade-set="80">Grade-80</button>
        <button class="grade-btn" data-grade-set="75">Grade-75</button>
        <button class="grade-btn" data-grade-set="70">Grade-70</button>
    </div>
    <table id="gradeRangesTable">
    <tr><th>Grade</th><th>From</th><th>To</th></tr>
    <tr><td>A+</td><td><input type="number" class="rangeFrom" data-grade="A+" value="85"></td><td><input type="number" class="rangeTo" data-grade="A+" value="100"></td></tr>
    <tr><td>A</td><td><input type="number" class="rangeFrom" data-grade="A" value="75"></td><td><input type="number" class="rangeTo" data-grade="A" value="84"></td></tr>
    <tr><td>B</td><td><input type="number" class="rangeFrom" data-grade="B" value="60"></td><td><input type="number" class="rangeTo" data-grade="B" value="74"></td></tr>
    <tr><td>C</td><td><input type="number" class="rangeFrom" data-grade="C" value="45"></td><td><input type="number" class="rangeTo" data-grade="C" value="59"></td></tr>
    <tr><td>D</td><td><input type="number" class="rangeFrom" data-grade="D" value="33"></td><td><input type="number" class="rangeTo" data-grade="D" value="44"></td></tr>
    <tr><td>E1</td><td><input type="number" class="rangeFrom" data-grade="E1" value="20"></td><td><input type="number" class="rangeTo" data-grade="E1" value="32"></td></tr>
    <tr><td>E2</td><td><input type="number" class="rangeFrom" data-grade="E2" value="0"></td><td><input type="number" class="rangeTo" data-grade="E2" value="19"></td></tr>
    </table>
    Max Marks: <input type="number" id="maxMarksInput" value="100">
</div>

<!-- How To Use Modal -->
<div id="howToUseModal">
    <div id="howToUseContent">
        <div id="howToUseContentHeader">
            How to Use
            <button id="closeHowToUse" title="Close">&times;</button>
        </div>
        <div id="howToUseDetails">
            <ul>
                <li>à¤—à¥à¤°à¥‡à¤¡ à¤¨à¤¿à¤•à¤¾à¤²à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤¯à¥‡ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¥‹à¤‚ à¤•à¤¾ Step by Step à¤ªà¤¾à¤²à¤¨ à¤•à¤°à¥‡à¤‚à¥¤</li>
                <li>à¤¸à¤¬à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ <b>Grade Range</b> à¤¸à¥‡ 100, 80, 75, 70 à¤®à¥‡à¤‚ à¤¸à¥‡ à¤—à¥à¤°à¥‡à¤¡ à¤¸à¤¿à¤²à¥‡à¤•à¥à¤Ÿ à¤•à¤°à¥‡à¤‚ à¥¤ <br>
                  <b>à¤—à¥à¤°à¥‡à¤¡ à¤°à¥‡à¤‚à¤œ à¤†à¤ª à¤–à¥à¤¦ à¤­à¥€ à¤¸à¥‡à¤Ÿ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤</b>
                </li>
                <li>à¤‰à¤¸à¤•à¥‡ à¤¬à¤¾à¤¦ Student table à¤•à¥€ à¤ªà¤¹à¤²à¥€ à¤²à¤¾à¤ˆà¤¨ à¤®à¥‡à¤‚ à¤ªà¤¹à¤²à¤¾ à¤°à¥‹à¤² à¤¨à¤®à¥à¤¬à¤° à¤¡à¤¾à¤²à¥‡à¤‚à¥¤</li>
                <li>à¤‰à¤¸à¤•à¥‡ à¤¬à¤¾à¤¦ 'Ad Row' à¤¬à¤Ÿà¤¨ à¤ªà¥à¤°à¥‡à¤¸ à¤•à¤° à¤›à¤¾à¤¤à¥à¤° à¤¸à¤‚à¤–à¥à¤¯à¤¾ à¤…à¤¨à¥à¤¸à¤¾à¤° à¤²à¤¾à¤‡à¤¨ à¤à¤¡ à¤•à¤°à¥‡à¤‚, à¤¤à¤¬ à¤…à¤—à¤²à¥‡ à¤¸à¤­à¥€ à¤°à¥‹à¤² à¤¨à¤®à¥à¤¬à¤° à¤­à¥€ à¤…à¤ªà¤¨à¥‡ à¤†à¤ª à¤à¤¡ à¤¹à¥‹à¤¤à¥‡ à¤œà¤¾à¤à¤‚à¤—à¥‡à¥¤</li>
                <li>à¤«à¤¿à¤° à¤¨à¤¾à¤®, à¤œà¤¨à¥à¤® à¤¦à¤¿à¤¨à¤¾à¤‚à¤•, à¤²à¤¿à¤‚à¤—, à¤œà¤¾à¤¤à¤¿ à¤­à¤°à¥‡à¤‚, à¤œà¥‹ à¤•à¤¾à¤²à¤® à¤¨à¤¹à¥€à¤‚ à¤šà¤¾à¤¹à¤¿à¤¯à¥‡ à¤‰à¤¸à¥‡ à¤¨à¤¾ à¤­à¤°à¥‡à¤‚à¥¤ à¤šà¤¾à¤¹à¥‡à¤‚ à¤¤à¥‹ à¤‰à¤¸ à¤•à¤¾à¤²à¤® à¤•à¥‹ <b>'Hide Colum'</b> à¤¸à¥‡ à¤¸à¤¿à¤²à¥‡à¤•à¥à¤Ÿ à¤•à¤° à¤¹à¤¾à¤‡à¤¡ à¤­à¥€ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤œà¤¬ à¤šà¤¾à¤¹à¥‡à¤‚ à¤¤à¥‹ <b>'Show Colimn'</b> à¤¸à¥‡ à¤µà¤¾à¤ªà¤¸ à¤¦à¥‡à¤– à¤¸à¤•à¤¤à¥… à¤¹à¥ˆà¤‚à¥¤</li>
                <li>à¤…à¤‚à¤¤ à¤®à¥‡à¤‚ <b>'Obtained Marks'</b> à¤®à¥‡à¤‚ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤­à¤°à¤¤à¥‡ à¤œà¤¾à¤à¤‚à¥¤ à¤…à¤‚à¤• 2 à¤¡à¤¿à¤œà¤¿à¤Ÿ à¤®à¥‡à¤‚ à¤¹à¥€ à¤­à¤°à¥‡à¤‚à¥¤</li>
                <li>0 à¤¯à¤¾ 1 à¤¸à¥‡ 9 à¤¤à¤• à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤¹à¥‹à¤¨à¥‡ à¤ªà¤° 00, 01, 02 à¤†à¤¦à¤¿ à¤­à¤°à¥‡à¤‚à¥¤ à¤¦à¥‹ à¤¡à¤¿à¤œà¤¿à¤Ÿ à¤­à¤°à¤¨à¥‡ à¤ªà¤° à¤•à¤°à¥à¤¸à¤° à¤…à¤—à¤²à¥‡ à¤•à¤¾à¤²à¤® à¤®à¥‡à¤‚ à¤šà¤²à¤¾ à¤œà¤¾à¤à¤—à¤¾à¥¤</li>
                <li>à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤¾à¤‚à¤• à¤­à¤°à¤¨à¥‡ à¤ªà¤° à¤†à¤ªà¤•à¥‡ à¤—à¥à¤°à¥‡à¤¡, à¤ªà¥à¤°à¤¤à¤¿à¤¶à¤¤ à¤”à¤° à¤—à¥à¤°à¥‡à¤¡ à¤µà¤¾à¤ˆà¤œ, à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤ˆà¤œ, à¤²à¤¿à¤‚à¤— à¤µà¤¾à¤ˆà¤œ à¤—à¥‹à¤¶à¤µà¤¾à¤°à¤¾ à¤®à¤¿à¤² à¤œà¤¾à¤à¤—à¤¾à¥¤</li>
                <li>à¤²à¤¿à¤‚à¤— à¤”à¤° à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤ˆà¤œ à¤—à¥‹à¤¶à¤µà¤¾à¤°à¥‡ à¤•à¥‡ à¤²à¤¿à¤¯à¥‡ à¤†à¤ªà¤•à¥‹ à¤¸à¥à¤Ÿà¥à¤¡à¥‡à¤‚à¤Ÿ à¤•à¥‡ à¤²à¤¿à¤‚à¤— à¤”à¤° à¤œà¤¾à¤¤à¤¿ à¤µà¤¾à¤²à¥‡ à¤•à¤¾à¤²à¤® à¤­à¤°à¤¨à¤¾ à¤¹à¥‹à¤‚à¤—à¥‡à¥¤</li>
                <li>à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤®à¥‡à¤‚ à¤¸à¤¿à¤²à¥‡à¤•à¥à¤Ÿ à¤†à¤ªà¥à¤¶à¤¨ à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤†à¤ª à¤œà¥‹ à¤¡à¤¾à¤Ÿà¤¾ à¤šà¤¾à¤¹à¤¿à¤¯à¥‡ à¤‰à¤¸à¤•à¥€ à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤¯à¤¾ <b>pdf</b> à¤¸à¥‡à¤µ à¤•à¤° à¤¸à¤•à¥‡à¤‚à¤—à¥‡à¥¤</li>
                <li>Reset Student Table à¤¸à¥‡ à¤ªà¥‚à¤°à¥€ à¤Ÿà¥‡à¤¬à¤² à¤°à¤¿à¤¸à¥‡à¤Ÿ à¤¹à¥‹ à¤œà¤¾à¤à¤—à¥€à¥¤</li>
                <li>Delete à¤†à¤ªà¥à¤¶à¤¨ à¤¸à¥‡ à¤ªà¥‚à¤°à¥€ à¤²à¤¾à¤ˆà¤¨ à¤¡à¤¿à¤²à¥€à¤Ÿ à¤¹à¥‹ à¤œà¤¾à¤à¤—à¥€à¥¤</li>
                <li>à¤•à¥à¤› error à¤¯à¤¾ à¤¸à¤œà¥‡à¤¶à¤¨ à¤•à¥‡ à¤²à¤¿à¤¯à¥‡ à¤¹à¤®à¥‡à¤‚ E-mail à¤•à¤°à¥‡à¤‚à¥¤<br>
                  <b>E-mail us at: <a href="mailto:skycommunics@gmail.com" class="email-link">skycommunics@gmail.com</a></b>
                </li>
            </ul>
        </div>
    </div>
</div>
<!-- End Modal -->

<div class="table-wrapper">
    <div class="table-title">Students Table</div>
    <div id="studentsControls">
        <label for="hideColumnSelect">Hide Column:</label>
        <select id="hideColumnSelect" class="hideBtn"></select>
        <label for="showColumnSelect">Show Column:</label>
        <select id="showColumnSelect" class="showBtn"></select>
        <button id="resetStudentsBtn">Reset Student Table</button>
        <span id="hiddenColumnsIndicator"></span>
    </div>
    <table id="studentsTable">
    <thead>
    <tr>
    <th>S.No</th>
    <th>Roll No</th>
    <th>Name</th>
    <th>Gender</th>
    <th>Caste</th>
    <th>DOB</th>
    <th>Obtained Marks</th>
    <th>Grade</th>
    <th>Percentage</th>
    <th>Action</th>
    </tr>
    </thead>
    <tbody></tbody>
    </table>
    <button id="addRowBtn">+ Add Row</button>
</div>

<div class="table-wrapper">
    <div class="table-title">Grade Summary</div>
    <table id="gradeSummary" class="summary-table">
    <thead><tr><th>Grade</th><th>Count</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th>Total</th><th id="gradeTotal">-</th></tr></tfoot>
    </table>
</div>

<div class="table-wrapper">
    <div class="table-title">Gender-wise Grade Summary</div>
    <table id="genderSummary" class="summary-table">
    <thead>
        <tr>
            <th>Gender</th>
            <th>A+</th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
            <th>D</th>
            <th>E1</th>
            <th>E2</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Male</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>Female</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td>Total</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
    </tfoot>
    </table>
</div>

<div class="table-wrapper">
    <div class="table-title">Caste-wise Grade Summary</div>
    <table id="casteSummary" class="summary-table">
    <thead>
        <tr>
            <th>Caste</th>
            <th>A+</th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
            <th>D</th>
            <th>E1</th>
            <th>E2</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>SC</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>ST</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>OBC</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>General</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td>Total</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
    </tfoot>
    </table>
</div>

<div class="table-wrapper">
    <div id="exportControls">
        <div id="printOptions">
            <select id="printSelect">
                <option value="">Select</option>
                <option value="students">Student Table</option>
                <option value="grade">Grade Summary</option>
                <option value="gender">Gender Summary</option>
                <option value="caste">Caste Summary</option>
                <option value="all">All</option>
            </select>
            <button id="printBtn">Print</button>
        </div>
        <button id="exportExcelBtn">Export to Excel</button>
    </div>
</div>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// How to Use Modal Logic
document.getElementById("howToUseBtn").onclick = function() {
    document.getElementById("howToUseModal").style.display = "block";
    document.body.style.overflow = "hidden";
};
document.getElementById("closeHowToUse").onclick = function() {
    document.getElementById("howToUseModal").style.display = "none";
    document.body.style.overflow = "";
};
document.getElementById("howToUseModal").onclick = function(e) {
    if(e.target === this) {
        this.style.display = "none";
        document.body.style.overflow = "";
    }
};

// --- Existing untouched JS below ---

let hiddenColumns = [];
const columnNames = [
    "S.No", "Roll No", "Name", "Gender", "Caste", "DOB", "Obtained Marks", "Grade", "Percentage", "Action"
];

function saveToLocalStorage(data) {
    localStorage.setItem("studentsTableData", JSON.stringify(data));
}
function loadFromLocalStorage() {
    let data = localStorage.getItem("studentsTableData");
    return data ? JSON.parse(data) : null;
}

// Save all data (students table, grade ranges, max marks)
function getCurrentData() {
    // Students
    let students = [];
    document.querySelectorAll("#studentsTable tbody tr").forEach(row => {
        students.push({
            roll: row.querySelector(".roll")?.value || "",
            name: row.querySelector('input[type="text"]')?.value || "",
            gender: row.querySelector(".gender")?.value || "",
            caste: row.querySelector(".caste")?.value || "",
            dob: row.querySelector(".dob-input")?.value || "",
            marks: row.querySelector(".marks")?.value || ""
        });
    });
    // Grade ranges
    let gradeRanges = [];
    document.querySelectorAll("#gradeRangesTable tr").forEach((tr, idx) => {
        if(idx==0) return;
        gradeRanges.push({
            grade: tr.cells[0].textContent,
            from: tr.cells[1].querySelector("input").value,
            to: tr.cells[2].querySelector("input").value
        });
    });
    let maxMarks = document.getElementById("maxMarksInput").value;
    return {students, gradeRanges, maxMarks};
}

// Restore all data
function restoreData(data) {
    // Grade ranges
    if(data.gradeRanges){
        let trs = document.querySelectorAll("#gradeRangesTable tr");
        data.gradeRanges.forEach((gr, i) => {
            if(trs[i+1]) {
                trs[i+1].cells[1].querySelector("input").value = gr.from;
                trs[i+1].cells[2].querySelector("input").value = gr.to;
            }
        });
    }
    // Max marks
    if(data.maxMarks){
        document.getElementById("maxMarksInput").value = data.maxMarks;
    }
    // Students
    const tbody=document.querySelector("#studentsTable tbody");
    tbody.innerHTML="";
    if(data.students && data.students.length>0){
        data.students.forEach((st,i)=>{
            let row = addRow(st.roll);
            row.querySelector('input[type="text"]').value = st.name;
            row.querySelector(".gender").value = st.gender;
            row.querySelector(".caste").value = st.caste;
            row.querySelector(".dob-input").value = st.dob;
            row.querySelector(".marks").value = st.marks;
        });
    } else {
        addRow();
    }
}

function updateHideShowSelects() {
    const hideSelect = document.getElementById('hideColumnSelect');
    const showSelect = document.getElementById('showColumnSelect');
    hideSelect.innerHTML = '';
    showSelect.innerHTML = '';
    let firstOpt = document.createElement('option');
    firstOpt.textContent = 'Select';
    firstOpt.value = '';
    firstOpt.disabled = true;
    firstOpt.selected = true;
    hideSelect.appendChild(firstOpt);
    columnNames.forEach((col, idx) => {
        if(!hiddenColumns.includes(idx) && idx !== 0 && idx !== columnNames.length-1){
            let opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = col;
            hideSelect.appendChild(opt);
        }
    });
    let firstOptShow = document.createElement('option');
    firstOptShow.textContent = 'Select';
    firstOptShow.value = '';
    firstOptShow.disabled = true;
    firstOptShow.selected = true;
    showSelect.appendChild(firstOptShow);
    hiddenColumns.forEach(idx => {
        if(idx !== 0 && idx !== columnNames.length-1){
            let opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = columnNames[idx];
            showSelect.appendChild(opt);
        }
    });
    if(hideSelect.options.length===1){
        let opt = document.createElement('option');
        opt.textContent = 'No column to hide';
        opt.disabled = true;
        hideSelect.appendChild(opt);
    }
    if(showSelect.options.length===1){
        let opt = document.createElement('option');
        opt.textContent = 'No column to show';
        opt.disabled = true;
        showSelect.appendChild(opt);
    }
    hideSelect.selectedIndex = 0;
    showSelect.selectedIndex = 0;
}

function updateHiddenColumnsIndicator() {
    const indicator = document.getElementById('hiddenColumnsIndicator');
    if(hiddenColumns.length === 0) {
        indicator.innerHTML = "";
        return;
    }
    let html = "Hidden: ";
    hiddenColumns.forEach(idx => {
        html += `<span class="hidden-column-indicator" data-index="${idx}">${columnNames[idx]}</span>`;
    });
    indicator.innerHTML = html;
}

// --- Hide Column Logic ---
document.getElementById("hideColumnSelect").addEventListener("change", function(){
    let idx = parseInt(this.value);
    if(hiddenColumns.includes(idx) || idx < 1 || idx === columnNames.length-1) return;
    document.querySelectorAll("#studentsTable thead th")[idx].style.display="none";
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        if(row.cells[idx]) row.cells[idx].style.display="none";
    });
    hiddenColumns.push(idx);
    updateHideShowSelects();
    updateHiddenColumnsIndicator();
});

// --- Show Column Logic ---
document.getElementById("showColumnSelect").addEventListener("change", function(){
    let idx = parseInt(this.value);
    if(!hiddenColumns.includes(idx)) return;
    document.querySelectorAll("#studentsTable thead th")[idx].style.display="";
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        if(row.cells[idx]) row.cells[idx].style.display="";
    });
    hiddenColumns = hiddenColumns.filter(i=>i!==idx);
    updateHideShowSelects();
    updateHiddenColumnsIndicator();
});

// Show column by clicking on indicator
document.getElementById('hiddenColumnsIndicator').addEventListener('click', function(e){
    if(e.target.classList.contains('hidden-column-indicator')) {
        let idx = parseInt(e.target.dataset.index);
        document.querySelectorAll("#studentsTable thead th")[idx].style.display="";
        document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
            if(row.cells[idx]) row.cells[idx].style.display="";
        });
        hiddenColumns = hiddenColumns.filter(i=>i!==idx);
        updateHideShowSelects();
        updateHiddenColumnsIndicator();
    }
});

function getGrade(marks){
    const ranges={};
    document.querySelectorAll(".rangeFrom").forEach((f,i)=>{
        const g=f.dataset.grade;
        ranges[g]=[parseInt(f.value),parseInt(document.querySelectorAll(".rangeTo")[i].value)];
    });
    for(let g in ranges){
        let [from,to]=ranges[g];
        if(marks>=from && marks<=to) return g;
    }
    return "";
}

function updateAllRows(){
    const maxMarks=parseFloat(document.getElementById("maxMarksInput").value)||100;
    document.querySelectorAll("#studentsTable tbody tr").forEach(row=>{
        const marksInput=row.querySelector(".marks");
        let marks=parseFloat(marksInput.value);
        // Red box on invalid, normal on valid
        if(!isNaN(marks) && marks>maxMarks){
            marksInput.classList.add("invalid");
        } else {
            marksInput.classList.remove("invalid");
        }
        const gradeCell=row.querySelector(".grade");
        const percentCell=row.querySelector(".percent");
        if(!isNaN(marks)){
            let grade=getGrade(marks);
            gradeCell.textContent=grade;
            percentCell.textContent=((marks/maxMarks)*100).toFixed(2);
        } else {
            gradeCell.textContent="";
            percentCell.textContent="";
        }
    });
    updateAllSummaries();
    saveToLocalStorage(getCurrentData());
}

function attachRowEvents(row){
    row.querySelector(".marks").addEventListener("input",function(e){
        const maxMarks = parseFloat(document.getElementById("maxMarksInput").value)||100;
        let val = parseFloat(this.value);
        if(!isNaN(val) && val>maxMarks){
            this.classList.add("invalid");
        } else {
            this.classList.remove("invalid");
        }
        updateAllRows();
        if(this.value.length >= 2){
            let currRow = this.closest('tr');
            let allRows = Array.from(document.querySelectorAll("#studentsTable tbody tr"));
            let idx = allRows.indexOf(currRow);
            if(idx < allRows.length-1){
                let nextRow = allRows[idx+1];
                let nextInput = nextRow.querySelector(".marks");
                if(nextInput) nextInput.focus();
            }
        }
    });
    row.querySelector(".roll").addEventListener("input",updateAllRows);
    row.querySelector('input[type="text"]').addEventListener("input",updateAllRows);
    row.querySelector(".gender").addEventListener("change",updateAllRows);
    row.querySelector(".caste").addEventListener("change",updateAllRows);
    row.querySelector(".deleteBtn").addEventListener("click",()=>{
        row.remove();
        updateSerialNumbers();
        updateAllRows();
    });
    let dobInput = row.querySelector(".dob-input");
    dobInput.addEventListener("input",function(e){
        let v = dobInput.value.replace(/[^\d]/g,"");
        if(v.length>2) v = v.slice(0,2)+"/"+v.slice(2);
        if(v.length>5) v = v.slice(0,5)+"/"+v.slice(5);
        dobInput.value = v.slice(0,10);
        let parts = dobInput.value.split("/");
        let invalid=false;
        if(parts.length===3) {
            let d = parseInt(parts[0]), m = parseInt(parts[1]), y = parseInt(parts[2]);
            let dateObj = new Date(y,m-1,d);
            if(isNaN(dateObj.getTime()) || d<1 || m<1 || m>12 || y<1900 || y>2100 ||
                dateObj.getDate()!=d || dateObj.getMonth()!=m-1 || dateObj.getFullYear()!=y) {
                invalid=true;
            }
        } else if(dobInput.value.length===10) {
            invalid=true;
        }
        let err = dobInput.nextElementSibling;
        if(invalid) {
            dobInput.classList.add("invalid");
            err.style.display="block";
        } else {
            dobInput.classList.remove("invalid");
            err.style.display="none";
        }
        updateAllRows();
    });
    dobInput.addEventListener("blur",updateAllRows);
}

function addRow(rollNo){
    const tbody=document.querySelector("#studentsTable tbody");
    const row=document.createElement("tr");
    const serial=tbody.children.length+1;
    row.innerHTML=`
        <td>${serial}</td>
        <td><input type="number" class="roll"></td>
        <td><input type="text" placeholder="Name"></td>
        <td>
          <select class="gender">
            <option value="">--</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </td>
        <td>
          <select class="caste">
            <option value="">--</option>
            <option value="SC">SC</option>
            <option value="ST">ST</option>
            <option value="OBC">OBC</option>
            <option value="General">General</option>
          </select>
        </td>
        <td><input type="text" class="dob-input" placeholder="DD/MM/YYYY" maxlength="10"><div class="error-text">Invalid Date</div></td>
        <td><input type="number" class="marks"></td>
        <td class="grade"></td>
        <td class="percent"></td>
        <td><button class="deleteBtn">Delete</button></td>`;
    tbody.appendChild(row);
    if(rollNo) row.querySelector(".roll").value=rollNo;
    attachRowEvents(row);
    hiddenColumns.forEach(idx=>{
        if(row.cells[idx]) row.cells[idx].style.display="none";
    });
    return row;
}

function updateSerialNumbers(){
    document.querySelectorAll("#studentsTable tbody tr").forEach((r,i)=>r.cells[0].textContent=i+1);
}

function updateAllSummaries(){
    let gradeCounts={"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0};
    let genderCounts={"M":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"F":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0}};
    let casteCounts={"SC":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"ST":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"OBC":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0},"General":{"A+":0,"A":0,"B":0,"C":0,"D":0,"E1":0,"E2":0}};
    document.querySelectorAll("#studentsTable tbody tr").forEach(r=>{
        let grade=r.querySelector(".grade").textContent;
        let gender=r.querySelector(".gender").value;
        let caste=r.querySelector(".caste").value;
        if(gradeCounts[grade]!=undefined) gradeCounts[grade]++;
        if(gender && genderCounts[gender][grade]!=undefined) genderCounts[gender][grade]++;
        if(caste && casteCounts[caste][grade]!=undefined) casteCounts[caste][grade]++;
    });
    let gradeBody=document.querySelector("#gradeSummary tbody");
    gradeBody.innerHTML="";
    let totalGrades=0;
    for(let g in gradeCounts){
        gradeBody.innerHTML+=`<tr><td>${g}</td><td>${gradeCounts[g]||"-"}</td></tr>`;
        totalGrades+=gradeCounts[g];
    }
    document.getElementById("gradeTotal").textContent=totalGrades||"-";
    let genderRows=document.querySelectorAll("#genderSummary tbody tr");
    ["M","F"].forEach((g,i)=>{
        let tds=genderRows[i].querySelectorAll("td");
        let rowTotal=0;
        let j=1;
        for(let gr in gradeCounts){
            tds[j].textContent=genderCounts[g][gr]||"-";
            rowTotal+=genderCounts[g][gr];
            j++;
        }
        tds[tds.length-1].textContent=rowTotal||"-";
    });
    let totalRow=document.querySelector("#genderSummary tfoot tr");
    totalRow.querySelectorAll("td").forEach((td,idx)=>{
        if(idx===0){td.textContent="Total"; return;}
        let sum=0;
        ["M","F"].forEach(g=>{sum+=parseInt(document.querySelector(`#genderSummary tbody tr:nth-child(${g=="M"?1:2}) td:nth-child(${idx+1})`).textContent)||0;});
        td.textContent=sum||"-";
    });
    let casteRows=document.querySelectorAll("#casteSummary tbody tr");
    ["SC","ST","OBC","General"].forEach((c,i)=>{
        let tds=casteRows[i].querySelectorAll("td");
        let rowTotal=0;
        let j=1;
        for(let gr in gradeCounts){
            tds[j].textContent=casteCounts[c][gr]||"-";
            rowTotal+=casteCounts[c][gr];
            j++;
        }
        tds[tds.length-1].textContent=rowTotal||"-";
    });
    let casteTotalRow=document.querySelector("#casteSummary tfoot tr");
    casteTotalRow.querySelectorAll("td").forEach((td,idx)=>{
        if(idx===0){td.textContent="Total"; return;}
        let sum=0;
        ["SC","ST","OBC","General"].forEach((c,i)=>{sum+=parseInt(casteRows[i].querySelectorAll("td")[idx].textContent)||0;});
        td.textContent=sum||"-";
    });
}

document.getElementById("addRowBtn").addEventListener("click",()=>{
    const tbody=document.querySelector("#studentsTable tbody");
    let lastRoll=tbody.lastElementChild?parseInt(tbody.lastElementChild.querySelector(".roll").value)||0:0;
    addRow(lastRoll+1);
    updateAllRows();
});
document.getElementById("resetStudentsBtn").addEventListener("click",()=>{
    document.querySelector("#studentsTable tbody").innerHTML="";
    addRow();
    updateAllRows();
    localStorage.removeItem("studentsTableData"); // Only reset here
});
document.getElementById("maxMarksInput").addEventListener("input",updateAllRows);
document.querySelectorAll(".rangeFrom, .rangeTo").forEach(inp=>inp.addEventListener("input",updateAllRows));

const gradeSets = {
    "100": {
        from: [85,75,60,45,33,20,0],
        to:   [100,84,74,59,44,32,19],
        maxMarks: 100
    },
    "80": {
        from: [68,60,48,36,27,16,0],
        to:   [80,67,59,47,35,26,15],
        maxMarks: 80
    },
    "75": {
        from: [64,56,45,34,25,15,0],
        to:   [75,63,55,44,33,24,14],
        maxMarks: 75
    },
    "70": {
        from: [60,53,42,32,23,14,0],
        to:   [70,59,52,41,31,22,13],
        maxMarks: 70
    }
};

document.querySelectorAll('.grade-btn').forEach(btn=>{
    btn.addEventListener('click', function(){
        const set = gradeSets[this.dataset.gradeSet];
        if(set){
            const froms = document.querySelectorAll('.rangeFrom');
            const tos = document.querySelectorAll('.rangeTo');
            set.from.forEach((val,i)=>froms[i].value=val);
            set.to.forEach((val,i)=>tos[i].value=val);
            document.getElementById('maxMarksInput').value = set.maxMarks;
            updateAllRows();
        }
    });
});

// Restore table on page load
window.addEventListener("DOMContentLoaded",function(){
    let data = loadFromLocalStorage();
    if(data){
        restoreData(data);
    } else {
        addRow();
    }
    updateAllRows();
    updateHideShowSelects();
});
// Save on every change
document.addEventListener("input",function(e){
    if(e.target.closest("#studentsTable") || e.target.closest("#gradeRangesTable") || e.target.id=="maxMarksInput"){
        saveToLocalStorage(getCurrentData());
    }
});

document.getElementById("exportExcelBtn").addEventListener("click",()=>{
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.table_to_sheet(document.getElementById("studentsTable"));
    XLSX.utils.book_append_sheet(wb, ws1, "Students");
    const ws2 = XLSX.utils.table_to_sheet(document.getElementById("gradeSummary"));
    XLSX.utils.book_append_sheet(wb, ws2, "Grade Summary");
    const ws3 = XLSX.utils.table_to_sheet(document.getElementById("genderSummary"));
    XLSX.utils.book_append_sheet(wb, ws3, "Gender Summary");
    const ws4 = XLSX.utils.table_to_sheet(document.getElementById("casteSummary"));
    XLSX.utils.book_append_sheet(wb, ws4, "Caste Summary");
    XLSX.writeFile(wb, "Student_Grades.xlsx");
});

document.getElementById("printBtn").addEventListener("click", function(){
    let val = document.getElementById("printSelect").value;
    if (!val) return;
    let toPrint;
    if(val==="students") {
        // Print student table with input values
        const studentsTable = document.getElementById("studentsTable");
        let tableClone = studentsTable.cloneNode(true);
        let thead = tableClone.querySelector("thead");
        let tbody = tableClone.querySelector("tbody");
        hiddenColumns.forEach(idx => {
            if (thead && thead.rows[0].cells[idx]) thead.rows[0].cells[idx].style.display = "";
            if (tbody) {
                Array.from(tbody.rows).forEach(row=>{
                    if(row.cells[idx]) row.cells[idx].style.display = "";
                });
            }
        });
        // Convert inputs/selects to their values
        Array.from(tbody.rows).forEach(row=>{
            for(let i=0; i<row.cells.length; i++){
                let cell = row.cells[i];
                let input = cell.querySelector("input");
                let select = cell.querySelector("select");
                if(input) {
                    let val = input.value;
                    cell.innerHTML = val;
                }
                if(select) {
                    let val = select.options[select.selectedIndex].textContent;
                    cell.innerHTML = val=="--"?"":val;
                }
            }
        });
        let printHTML = '<table style="border-collapse:collapse;">'+thead.outerHTML+tbody.outerHTML+'</table>';
        let printWindow = window.open('', '', 'height=900,width=1200');
        printWindow.document.write('<html><head><title>Print</title>');
        printWindow.document.write('<style>th{background:#222;color:#fff;}tfoot tr, tfoot th, tfoot td{background:#222 !important;color:#fff !important;font-weight:bold;}table{border-collapse:collapse;}th,td{border:1px solid #333;padding:4px;text-align:center;}body{font-family:Arial,sans-serif;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(printHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(()=>printWindow.print(),200);
        return;
    }
    else if(val==="grade") toPrint = document.querySelector(".table-wrapper:nth-of-type(3)");
    else if(val==="gender") toPrint = document.querySelector(".table-wrapper:nth-of-type(4)");
    else if(val==="caste") toPrint = document.querySelector(".table-wrapper:nth-of-type(5)");
    else if(val==="all") toPrint = document.body;
    let printContents = (toPrint===document.body) ? document.body.innerHTML : toPrint.outerHTML;
    let dummy = document.createElement('div');
    dummy.innerHTML = printContents;
    let exportBox = dummy.querySelector("#exportControls");
    if(exportBox) exportBox.style.display="none";
    let lastTitle = dummy.querySelector('.table-title');
    if(lastTitle && val!=="all") lastTitle.style.display="none";
    let style = '<style>th{background:#222;color:#fff;}tfoot tr, tfoot th, tfoot td{background:#222 !important;color:#fff !important;font-weight:bold;}table{border-collapse:collapse;}th,td{border:1px solid #333;padding:4px;text-align:center;}body{font-family:Arial,sans-serif;}</style>';
    let printWindow = window.open('', '', 'height=900,width=1200');
    printWindow.document.write('<html><head><title>Print</title>');
    printWindow.document.write(style);
    printWindow.document.write('</head><body>');
    printWindow.document.write(dummy.innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    setTimeout(()=>printWindow.print(),200);
});
</script>

</body>
</html>
